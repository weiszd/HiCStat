<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HiCStat — .hic File Header Inspector</title>
  <style>
    :root {
      --bg: #0f1117;
      --surface: #1a1d27;
      --surface2: #232733;
      --border: #2e3345;
      --text: #e1e4ed;
      --text2: #8b90a0;
      --accent: #6c8cff;
      --accent2: #4a6adf;
      --green: #4ade80;
      --orange: #fb923c;
      --red: #f87171;
      --mono: 'SF Mono', 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.6;
    }
    .container { max-width: 960px; margin: 0 auto; padding: 2rem 1.5rem; }
    header { text-align: center; margin-bottom: 2.5rem; }
    header h1 {
      font-size: 1.75rem;
      font-weight: 700;
      letter-spacing: -0.02em;
      margin-bottom: 0.5rem;
    }
    header h1 span { color: var(--accent); }
    header p { color: var(--text2); font-size: 0.9rem; }
    .input-group {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    .input-group input {
      flex: 1;
      padding: 0.75rem 1rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 0.95rem;
      outline: none;
      transition: border-color 0.2s;
    }
    .input-group input:focus { border-color: var(--accent); }
    .input-group input::placeholder { color: var(--text2); }
    .btn {
      padding: 0.75rem 1.5rem;
      background: var(--accent);
      border: none;
      border-radius: 8px;
      color: #fff;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
    }
    .btn:hover { background: var(--accent2); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .examples {
      color: var(--text2);
      font-size: 0.8rem;
      margin-bottom: 2rem;
    }
    .examples a {
      color: var(--accent);
      text-decoration: none;
      cursor: pointer;
    }
    .examples a:hover { text-decoration: underline; }
    #status {
      text-align: center;
      padding: 1rem;
      color: var(--text2);
      font-size: 0.9rem;
      display: none;
    }
    #status.visible { display: block; }
    #status .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      vertical-align: middle;
      margin-right: 0.5rem;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    #error {
      background: rgba(248,113,113,0.1);
      border: 1px solid rgba(248,113,113,0.3);
      border-radius: 8px;
      padding: 1rem;
      color: var(--red);
      font-size: 0.9rem;
      margin-bottom: 1.5rem;
      display: none;
    }
    #error.visible { display: block; }
    #results { display: none; }
    #results.visible { display: block; }
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      margin-bottom: 1.25rem;
      overflow: hidden;
    }
    .card-header {
      padding: 0.85rem 1.25rem;
      font-weight: 600;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text2);
      border-bottom: 1px solid var(--border);
      background: var(--surface2);
    }
    .card-body { padding: 1.25rem; }
    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
    }
    .stat-item { }
    .stat-label {
      font-size: 0.75rem;
      color: var(--text2);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 0.2rem;
    }
    .stat-value {
      font-family: var(--mono);
      font-size: 0.95rem;
      word-break: break-all;
    }
    .stat-value.large {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent);
    }
    .badge {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      border-radius: 4px;
      font-size: 0.8rem;
      font-family: var(--mono);
      font-weight: 500;
    }
    .badge-green { background: rgba(74,222,128,0.15); color: var(--green); }
    .badge-orange { background: rgba(251,146,60,0.15); color: var(--orange); }
    .badge-blue { background: rgba(108,140,255,0.15); color: var(--accent); }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.88rem;
    }
    th {
      text-align: left;
      padding: 0.5rem 0.75rem;
      color: var(--text2);
      font-weight: 600;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      border-bottom: 1px solid var(--border);
    }
    td {
      padding: 0.45rem 0.75rem;
      border-bottom: 1px solid rgba(46,51,69,0.5);
      font-family: var(--mono);
      font-size: 0.85rem;
    }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: rgba(108,140,255,0.04); }
    .res-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }
    .res-tag {
      padding: 0.25rem 0.6rem;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 5px;
      font-family: var(--mono);
      font-size: 0.82rem;
    }
    .attr-table { width: 100%; }
    .attr-table td:first-child {
      color: var(--text2);
      width: 180px;
      font-family: var(--mono);
      font-size: 0.82rem;
    }
    .attr-table td:last-child {
      font-family: var(--mono);
      font-size: 0.82rem;
      word-break: break-all;
    }
    .footer-text {
      text-align: center;
      color: var(--text2);
      font-size: 0.78rem;
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border);
    }
    .footer-text a { color: var(--accent); text-decoration: none; }
    .two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.25rem;
    }
    @media (max-width: 640px) {
      .two-col { grid-template-columns: 1fr; }
      .input-group { flex-direction: column; }
      .stat-grid { grid-template-columns: 1fr 1fr; }
    }
    .expandable-header {
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .expandable-header .arrow {
      transition: transform 0.2s;
      font-size: 0.7rem;
    }
    .expandable-header .arrow.open { transform: rotate(90deg); }
    .collapsible { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
    .collapsible.open { max-height: 5000px; }
    .stats-text-block {
      font-family: var(--mono);
      font-size: 0.8rem;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 400px;
      overflow-y: auto;
      padding: 1rem;
      background: var(--bg);
      border-radius: 6px;
      line-height: 1.5;
      color: var(--text2);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>HiC<span>Stat</span></h1>
      <p>Inspect .hic file headers from ENCODE or any URL</p>
    </header>

    <div class="input-group">
      <input type="text" id="input" placeholder="ENCODE accession (ENCFF...) or direct URL to .hic file" spellcheck="false">
      <button class="btn" id="goBtn" onclick="run()">Inspect</button>
    </div>
    <div class="examples">
      Try:
      <a onclick="setExample('ENCFF622YUQ')">ENCFF622YUQ</a> ·
      <a onclick="setExample('ENCFF148QCR')">ENCFF148QCR</a> ·
      <a onclick="setExample('https://hicfiles.s3.amazonaws.com/hiseq/gm12878/in-situ/combined.hic')">GM12878 in-situ (S3)</a> ·
      <a onclick="setExample('https://4dn-open-data-public.s3.amazonaws.com/fourfront-webprod/wfoutput/c377953b-0e61-426b-a905-abab2d5a3002/4DNFI9VXTBE2.hic')">4DN GM12878</a>
    </div>

    <div id="status"><span class="spinner"></span><span id="statusText">Loading...</span></div>
    <div id="error"></div>
    <div id="results"></div>

    <div class="footer-text">
      Reads only the header bytes — no full download required.
      Format spec: <a href="https://github.com/aidenlab/hic-format" target="_blank">aidenlab/hic-format</a>
    </div>
  </div>

<script>
// ─── Binary Parser ───────────────────────────────────────────────
class BinaryParser {
  constructor(dataView, littleEndian = true) {
    this.data = dataView;
    this.offset = 0;
    this.le = littleEndian;
  }
  getByte() { const v = this.data.getUint8(this.offset); this.offset += 1; return v; }
  getShort() { const v = this.data.getInt16(this.offset, this.le); this.offset += 2; return v; }
  getInt() { const v = this.data.getInt32(this.offset, this.le); this.offset += 4; return v; }
  getUInt() { const v = this.data.getUint32(this.offset, this.le); this.offset += 4; return v; }
  getLong() {
    // Read as two 32-bit ints (little-endian: low word first)
    const lo = this.data.getUint32(this.offset, this.le);
    const hi = this.data.getInt32(this.offset + 4, this.le);
    this.offset += 8;
    return BigInt(hi) * BigInt(4294967296) + BigInt(lo >>> 0);
  }
  getFloat() { const v = this.data.getFloat32(this.offset, this.le); this.offset += 4; return v; }
  getDouble() { const v = this.data.getFloat64(this.offset, this.le); this.offset += 8; return v; }
  getString() {
    let s = '';
    while (this.offset < this.data.byteLength) {
      const b = this.data.getUint8(this.offset++);
      if (b === 0) break;
      s += String.fromCharCode(b);
    }
    return s;
  }
  skip(n) { this.offset += n; }
  position() { return this.offset; }
}

// ─── .hic Header Parser ─────────────────────────────────────────
function parseHicHeader(buffer) {
  const dv = new DataView(buffer);
  const p = new BinaryParser(dv);

  // Magic
  const magic = p.getString();
  if (magic !== 'HIC') throw new Error(`Not a .hic file (magic="${magic}")`);

  // Version
  const version = p.getInt();
  if (version < 5) throw new Error(`Unsupported .hic version: ${version}`);

  // Footer position
  const footerPosition = p.getLong();

  // Genome ID
  const genomeId = p.getString();

  // v9+: normalization vector index info
  let normVectorIndexPosition = null;
  let normVectorIndexLength = null;
  if (version >= 9) {
    normVectorIndexPosition = p.getLong();
    normVectorIndexLength = p.getLong();
  }

  // Attributes
  const nAttributes = p.getInt();
  const attributes = {};
  for (let i = 0; i < nAttributes; i++) {
    const key = p.getString();
    const value = p.getString();
    attributes[key] = value;
  }

  // Chromosomes
  const nChrs = p.getInt();
  const chromosomes = [];
  for (let i = 0; i < nChrs; i++) {
    const name = p.getString();
    let size;
    if (version >= 9) {
      size = p.getLong();
    } else {
      size = BigInt(p.getInt());
    }
    chromosomes.push({ index: i, name, size });
  }

  // BP Resolutions
  const nBpResolutions = p.getInt();
  const bpResolutions = [];
  for (let i = 0; i < nBpResolutions; i++) {
    bpResolutions.push(p.getInt());
  }

  // Fragment resolutions
  const nFragResolutions = p.getInt();
  const fragResolutions = [];
  for (let i = 0; i < nFragResolutions; i++) {
    fragResolutions.push(p.getInt());
  }

  return {
    magic,
    version,
    footerPosition,
    genomeId,
    normVectorIndexPosition,
    normVectorIndexLength,
    nAttributes,
    attributes,
    nChrs,
    chromosomes,
    nBpResolutions,
    bpResolutions,
    nFragResolutions,
    fragResolutions,
    headerSizeBytes: p.position()
  };
}

// ─── Resolve URL ─────────────────────────────────────────────────
async function resolveUrl(input) {
  input = input.trim();
  // Direct URL
  if (input.startsWith('http://') || input.startsWith('https://')) {
    return { url: input, encodeMetadata: null };
  }
  // ENCODE accession: accept ENCFF..., or just the 6-char suffix
  const upper = input.toUpperCase();
  if (/^ENCFF[A-Z0-9]{6}$/.test(upper)) return resolveEncodeAccession(upper);
  if (/^[A-Z0-9]{6}$/.test(upper)) return resolveEncodeAccession('ENCFF' + upper);
  throw new Error(`Invalid input. Provide an ENCODE file accession (ENCFF...) or a URL.`);
}

async function resolveEncodeAccession(accession) {
  setStatus(`Fetching ENCODE metadata for ${accession}...`);
  const resp = await fetch(`https://www.encodeproject.org/files/${accession}/?format=json`, {
    headers: { 'Accept': 'application/json' }
  });
  if (!resp.ok) throw new Error(`ENCODE API returned ${resp.status} for ${accession}. Check the accession is valid.`);
  const meta = await resp.json();
  if (meta.file_format !== 'hic') throw new Error(`${accession} is not a .hic file (format: ${meta.file_format})`);
  const downloadUrl = `https://www.encodeproject.org${meta.href}`;
  return { url: downloadUrl, encodeMetadata: meta };
}

// ─── S3 Proxy Configuration ──────────────────────────────────────
const S3_PROXY_URL = 'https://pjrwcsbzsabikiezwter.supabase.co/functions/v1/hic-proxy';
const PROXIED_S3_HOSTS = [
  'hicfiles.s3.amazonaws.com',
  'hicfiles.s3.us-east-1.amazonaws.com',
];

function needsProxy(url) {
  try {
    const hostname = new URL(url).hostname.toLowerCase();
    return PROXIED_S3_HOSTS.includes(hostname);
  } catch { return false; }
}

// ─── Fetch header bytes ──────────────────────────────────────────
async function fetchHeaderBytes(url, size = 262144) {
  setStatus(`Fetching first ${(size/1024).toFixed(0)} KB of .hic file...`);

  let resp;
  try {
    if (needsProxy(url)) {
      // Route through our Edge Function proxy that adds Referer & User-Agent
      const proxyUrl = `${S3_PROXY_URL}?url=${encodeURIComponent(url)}&start=0&size=${size}`;
      setStatus(`Fetching via proxy (S3 requires auth headers)...`);
      resp = await fetch(proxyUrl, { method: 'GET', mode: 'cors' });
    } else {
      resp = await fetch(url, {
        method: 'GET',
        headers: { 'Range': `bytes=0-${size - 1}` },
        redirect: 'follow',
        mode: 'cors',
      });
    }
  } catch (networkErr) {
    throw new Error(`Network error fetching .hic file. The server may not support CORS or the URL may be inaccessible. (${networkErr.message})`);
  }

  if (resp.status === 403) {
    throw new Error(`Access denied (403). The file may require authentication or the S3 bucket permissions may have changed.`);
  }
  if (resp.status === 404) {
    throw new Error(`File not found (404). Check that the URL is correct.`);
  }
  if (!resp.ok && resp.status !== 206) {
    throw new Error(`Failed to fetch .hic file: HTTP ${resp.status} ${resp.statusText}`);
  }

  const buf = await resp.arrayBuffer();

  // Sanity check: make sure we got binary data, not an HTML redirect page
  if (buf.byteLength >= 4) {
    const magic = new Uint8Array(buf, 0, 4);
    const asStr = String.fromCharCode(magic[0], magic[1], magic[2]);
    if (asStr !== 'HIC') {
      // Could be HTML from a redirect that didn't resolve
      const textSnippet = new TextDecoder().decode(buf.slice(0, 200));
      if (textSnippet.includes('<!DOCTYPE') || textSnippet.includes('<html')) {
        throw new Error(`Received an HTML page instead of binary .hic data. The server may have redirected to a login page, or CORS may be blocking the actual file.`);
      }
    }
  }

  return buf;
}

// ─── Format helpers ──────────────────────────────────────────────
function fmtSize(bytes) {
  const n = Number(bytes);
  if (n < 1024) return n + ' B';
  if (n < 1048576) return (n / 1024).toFixed(1) + ' KB';
  if (n < 1073741824) return (n / 1048576).toFixed(1) + ' MB';
  if (n < 1099511627776) return (n / 1073741824).toFixed(2) + ' GB';
  return (n / 1099511627776).toFixed(2) + ' TB';
}

function fmtBpRes(bp) {
  if (bp >= 1000000) return (bp / 1000000) + ' Mb';
  if (bp >= 1000) return (bp / 1000) + ' Kb';
  return bp + ' bp';
}

function fmtBigInt(n) {
  return Number(n).toLocaleString();
}

function escHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

// ─── Render ──────────────────────────────────────────────────────
function renderResults(hdr, encodeMeta, fileUrl) {
  const r = document.getElementById('results');
  let html = '';

  // ENCODE metadata card (if present)
  if (encodeMeta) {
    const biosample = encodeMeta.biosample_ontology
      ? (Array.isArray(encodeMeta.biosample_ontology)
          ? encodeMeta.biosample_ontology.map(b => b.term_name).join(', ')
          : encodeMeta.biosample_ontology.term_name)
      : 'N/A';
    const lab = encodeMeta.lab
      ? (typeof encodeMeta.lab === 'object' ? encodeMeta.lab.title : encodeMeta.lab)
      : 'N/A';
    html += `
    <div class="card">
      <div class="card-header">ENCODE Metadata</div>
      <div class="card-body">
        <div class="stat-grid">
          <div class="stat-item">
            <div class="stat-label">Accession</div>
            <div class="stat-value"><a href="https://www.encodeproject.org/files/${encodeMeta.accession}/" target="_blank" style="color:var(--accent)">${encodeMeta.accession}</a></div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Assembly</div>
            <div class="stat-value"><span class="badge badge-green">${escHtml(encodeMeta.assembly || 'N/A')}</span></div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Output Type</div>
            <div class="stat-value">${escHtml(encodeMeta.output_type || 'N/A')}</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">File Size</div>
            <div class="stat-value">${encodeMeta.file_size ? fmtSize(encodeMeta.file_size) : 'N/A'}</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Biosample</div>
            <div class="stat-value">${escHtml(biosample)}</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Lab</div>
            <div class="stat-value">${escHtml(lab)}</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Assay</div>
            <div class="stat-value">${escHtml(Array.isArray(encodeMeta.assay_term_name) ? encodeMeta.assay_term_name.join(', ') : (encodeMeta.assay_term_name || 'N/A'))}</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Date Created</div>
            <div class="stat-value">${encodeMeta.date_created ? new Date(encodeMeta.date_created).toLocaleDateString() : 'N/A'}</div>
          </div>
          ${encodeMeta.submitted_file_name ? `<div class="stat-item" style="grid-column:1/-1">
            <div class="stat-label">Original File Name</div>
            <div class="stat-value">${escHtml(encodeMeta.submitted_file_name)}</div>
          </div>` : ''}
          ${encodeMeta.href ? `<div class="stat-item" style="grid-column:1/-1">
            <div class="stat-label">Download URL</div>
            <div class="stat-value"><a href="https://www.encodeproject.org${encodeMeta.href}" target="_blank" style="color:var(--accent)">https://www.encodeproject.org${escHtml(encodeMeta.href)}</a></div>
          </div>` : ''}
        </div>
      </div>
    </div>`;
  }

  // Main header info card
  html += `
  <div class="card">
    <div class="card-header">HiC File Header</div>
    <div class="card-body">
      <div class="stat-grid">
        <div class="stat-item">
          <div class="stat-label">Format</div>
          <div class="stat-value large">.hic v${hdr.version}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Genome</div>
          <div class="stat-value large">${escHtml(hdr.genomeId)}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Chromosomes</div>
          <div class="stat-value large">${hdr.nChrs}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Header Size</div>
          <div class="stat-value">${fmtSize(hdr.headerSizeBytes)}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Footer Offset</div>
          <div class="stat-value">${fmtBigInt(hdr.footerPosition)}</div>
        </div>
        ${hdr.normVectorIndexPosition !== null ? `
        <div class="stat-item">
          <div class="stat-label">NormVector Index Pos</div>
          <div class="stat-value">${fmtBigInt(hdr.normVectorIndexPosition)}</div>
        </div>` : ''}
      </div>
    </div>
  </div>`;

  // Resolutions
  html += `
  <div class="two-col">
    <div class="card">
      <div class="card-header">Base-Pair Resolutions (${hdr.nBpResolutions})</div>
      <div class="card-body">
        <div class="res-tags">
          ${hdr.bpResolutions.map(r => `<span class="res-tag">${fmtBpRes(r)}</span>`).join('')}
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-header">Fragment Resolutions (${hdr.nFragResolutions})</div>
      <div class="card-body">
        ${hdr.nFragResolutions > 0
          ? `<div class="res-tags">${hdr.fragResolutions.map(r => `<span class="res-tag">${r}</span>`).join('')}</div>`
          : '<span style="color:var(--text2)">None</span>'
        }
      </div>
    </div>
  </div>`;

  // Chromosomes table
  const totalGenomeSize = hdr.chromosomes.reduce((s, c) => s + c.size, 0n);
  html += `
  <div class="card">
    <div class="card-header">Chromosomes · Total genome size: ${fmtBigInt(totalGenomeSize)} bp</div>
    <div class="card-body" style="padding:0;max-height:400px;overflow-y:auto">
      <table>
        <thead><tr><th>#</th><th>Name</th><th style="text-align:right">Size (bp)</th><th style="text-align:right">Size</th></tr></thead>
        <tbody>
          ${hdr.chromosomes.map(c => `
          <tr>
            <td>${c.index}</td>
            <td>${escHtml(c.name)}</td>
            <td style="text-align:right">${fmtBigInt(c.size)}</td>
            <td style="text-align:right;color:var(--text2)">${fmtSize(Number(c.size))}</td>
          </tr>`).join('')}
        </tbody>
      </table>
    </div>
  </div>`;

  // Attributes
  const attrKeys = Object.keys(hdr.attributes);
  if (attrKeys.length > 0) {
    // Separate "statistics" and "graphs" (long values) from short ones
    const shortAttrs = {};
    const longAttrs = {};
    for (const k of attrKeys) {
      if (hdr.attributes[k].length > 200 || k === 'statistics' || k === 'graphs') {
        longAttrs[k] = hdr.attributes[k];
      } else {
        shortAttrs[k] = hdr.attributes[k];
      }
    }
    const shortKeys = Object.keys(shortAttrs);
    const longKeys = Object.keys(longAttrs);

    html += `<div class="card">
      <div class="card-header">Attributes (${attrKeys.length})</div>
      <div class="card-body" style="padding:0">
        <table class="attr-table">
          <tbody>
            ${shortKeys.map(k => `<tr><td style="padding:0.5rem 0.75rem">${escHtml(k)}</td><td style="padding:0.5rem 0.75rem">${escHtml(shortAttrs[k])}</td></tr>`).join('')}
          </tbody>
        </table>
      </div>
    </div>`;

    // Expandable sections for long attributes (statistics, graphs)
    for (const k of longKeys) {
      let content = hdr.attributes[k];
      // Try to pretty-print if JSON-like
      let displayContent = content;
      if (k === 'statistics' || k === 'graphs') {
        try {
          // The statistics attribute is often a stringified JSON
          const parsed = JSON.parse(content);
          displayContent = JSON.stringify(parsed, null, 2);
        } catch {
          // Try to format as key-value pairs
          displayContent = content;
        }
      }
      const id = 'attr_' + k.replace(/\W/g, '_');
      const autoOpen = (k === 'statistics');
      html += `
      <div class="card">
        <div class="card-header expandable-header" onclick="toggleSection('${id}')">
          <span>${escHtml(k)}</span>
          <span class="arrow${autoOpen ? ' open' : ''}" id="${id}_arrow">&#9654;</span>
        </div>
        <div class="collapsible${autoOpen ? ' open' : ''}" id="${id}">
          <div class="card-body" style="padding:0.75rem">
            <div class="stats-text-block">${escHtml(displayContent)}</div>
          </div>
        </div>
      </div>`;
    }
  }

  r.innerHTML = html;
  r.classList.add('visible');
}

function toggleSection(id) {
  const el = document.getElementById(id);
  const arrow = document.getElementById(id + '_arrow');
  el.classList.toggle('open');
  arrow.classList.toggle('open');
}

// ─── UI Helpers ──────────────────────────────────────────────────
function setStatus(msg) {
  const el = document.getElementById('status');
  document.getElementById('statusText').textContent = msg;
  el.classList.add('visible');
}
function hideStatus() { document.getElementById('status').classList.remove('visible'); }
function showError(msg) {
  const el = document.getElementById('error');
  el.textContent = msg;
  el.classList.add('visible');
}
function hideError() { document.getElementById('error').classList.remove('visible'); }
function hideResults() { document.getElementById('results').classList.remove('visible'); }

function setExample(val) {
  document.getElementById('input').value = val;
  run();
}

// ─── Main ────────────────────────────────────────────────────────
async function run() {
  const input = document.getElementById('input').value.trim();
  if (!input) return;

  hideError();
  hideResults();
  const btn = document.getElementById('goBtn');
  btn.disabled = true;

  try {
    // 1. Resolve input to a URL
    setStatus('Resolving input...');
    const { url, encodeMetadata } = await resolveUrl(input);

    // 2. Fetch header bytes
    const buf = await fetchHeaderBytes(url);
    setStatus('Parsing .hic header...');

    // 3. Parse
    const header = parseHicHeader(buf);

    // 4. Render
    hideStatus();
    renderResults(header, encodeMetadata, url);

  } catch (err) {
    hideStatus();
    showError(err.message);
    console.error(err);
  } finally {
    btn.disabled = false;
  }
}

// Enter key
document.getElementById('input').addEventListener('keydown', e => {
  if (e.key === 'Enter') run();
});

// Auto-load from URL path: /HiCStat/ENCFF090JFB or /HiCStat/?q=https://...
(function autoLoad() {
  // Check path segment after /HiCStat/
  const path = window.location.pathname.replace(/\/$/, '');
  const base = path.substring(path.lastIndexOf('/') + 1);
  // Check query param ?q=
  const params = new URLSearchParams(window.location.search);
  const q = params.get('q');

  const input = q || (base && base.toLowerCase() !== 'hicstat' && base !== 'index.html' && base !== '' ? decodeURIComponent(base) : null);
  if (input) {
    document.getElementById('input').value = input;
    run();
  }
})();
</script>
</body>
</html>
